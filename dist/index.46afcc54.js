const e={layoutForm:document.querySelector("#layout-form"),layoutFormSubmit:document.querySelector("#layout-submit"),viewSwitcher:document.querySelector("#view-switcher"),layerNav:document.querySelector("#layer-nav"),keyboard:document.querySelector("#keyboard")},t={data:{},layers:[],layerStack:[],getCurrLayer(){return this.layerStack[this.layerStack.length-1]},toLocalStorage(e){localStorage.setItem("KBLayoutData",JSON.stringify(e))},fromLocalStorage:()=>JSON.parse(localStorage.getItem("KBLayoutData")),localStorageExists(){return null!==this.fromLocalStorage()}},r={layoutData(e){const t=e.split(/(?<=')$/m);let r={};for(i in t){let e=t[i].match(/^\w+$/m)[0],l=a(t[i]).map(((e,t)=>3===t?o(e,6):o(e)));r[e]=l}return r},layerNames:e=>Object.keys(e).map((e=>e))};function a(e){return e.match(/^\|[^\-].+$/gm)}function o(e,t){let r=e.replace(/((?<=\|)\s\|)|(^\|)|(\|$)/g,"").match(/.{1,8}/g),a=[];for(let e=0;e<r.length;e++)e==t?(a.push(`${r[e]}${r[e+1]}`),e++):a.push(r[e]);return a.map((e=>e.slice(0,-1)))}const n={addLayer(r){t.layerStack.push(r);let a=document.createElement("button");a.innerHTML=r,a.classList.add("layer-btn"),a.id=r,a.onclick=()=>{this.clicked(r)},e.layerNav.appendChild(a)},removeLayer(e){t.layerStack.pop(),document.getElementById(e).remove()},clicked(e){if(e==t.getCurrLayer()){if(t.layerStack.length>1){const e=t.getCurrLayer();this.removeLayer(e);const r=t.getCurrLayer();c.renderLayer(r)}}else{let r=t.getCurrLayer();for(;r!==e;)this.removeLayer(r),r=t.getCurrLayer();c.renderLayer(e)}}},c={renderLayer(e){let r=t.data[e];this.forAll(e,((e,a,o)=>{let l=r[a][o];const n=document.getElementById(e);n.classList.remove("pressed"),l.match(/^(\s+)?_+(\s+)?$/m)?(s.addFade(e),s.setContent(e,"")):(s.removeFade(e),s.getTargetLayer(l)===t.getCurrLayer()?(s.setContent(e,s.removeSquareBrackets(l)),n.classList.add("pressed")):s.setContent(e,l))})),this.updateInteractivity()},updateInteractivity(){const e=t.getCurrLayer();this.forAll(e,(e=>{!function(e){return t.layers.some((t=>e.includes(t)))}(s.getContent(e))?s.removeInteractivity(e):s.makeInteractive(e)}))},forAll(e,r){for(row in l=t.data[e],l)for(col in l[row]){r(`${row}x${col}`,row,col)}}},s={setContent(e,t){document.getElementById(e).getElementsByTagName("span")[0].innerHTML=t},getContent:e=>document.getElementById(e).getElementsByTagName("span")[0].innerHTML,getTargetLayer:e=>t.layers.find((t=>e.includes(t))),makeInteractive(e){let t=document.getElementById(e);t.onclick=()=>{this.clicked(e)},t.classList.add("clickeable")},removeInteractivity(e){let t=document.getElementById(e);t.onclick=null,t.classList.remove("clickeable")},clicked(e){const r=this.getContent(e);let a=this.getTargetLayer(r);if(a==t.getCurrLayer()){const e=t.getCurrLayer();n.removeLayer(e);const r=t.getCurrLayer();c.renderLayer(r)}else n.addLayer(a),c.renderLayer(a)},addFade(e){document.getElementById(e).classList.add("faded")},removeFade(e){document.getElementById(e).classList.remove("faded")},removeSquareBrackets:e=>e.replaceAll(/(^\[\s?)|(\s?\]$)/gm,"")};function y(){console.log("going to form view..."),e.keyboard.style.display="none",e.layerNav.style.display="none",e.viewSwitcher.style.display="none",e.layoutForm.style.removeProperty("display")}function d(){console.log("going to keyboard view..."),e.layoutForm.style.display="none",e.keyboard.style.removeProperty("display"),e.layerNav.style.removeProperty("display"),e.viewSwitcher.style.removeProperty("display")}t.localStorageExists()?(t.data=t.fromLocalStorage(),t.layers=r.layerNames(t.data),d(),n.addLayer("MAIN"),c.renderLayer("MAIN")):y(),e.layoutFormSubmit.addEventListener("click",(function(){const a=e.layoutForm.querySelector("textarea").value;t.data=r.layoutData(a),t.layers=r.layerNames(t.data),d(),0==t.layerStack.length&&n.addLayer("MAIN"),c.renderLayer("MAIN"),t.toLocalStorage(t.data)})),e.viewSwitcher.addEventListener("click",y);